name: JSON action

on:
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        test-folder:
          - 'sample-test'

    outputs:
      tests: ${{ steps.load_variables.outputs.json }}

    steps:
      # Checks-out only the content of the test folder
      - uses: actions/checkout@v4
        with:
          sparse-checkout: ${{ matrix.test-folder }}
          sparse-checkout-cone-mode: false

      - name: Create JSON definition for testing
        run: |
          echo '{"test": []}' | jq . > test.json

      - name: Load testing variables
        id: load_variables
        run: |
          echo "Loading JSON variables:"
          json=$(cat ${{ github.workspace }}/${{ matrix.test-folder }}/variables.json)
          
          echo "$(jq '.test += ["${{ matrix.test-folder }}"]' test.json)" > test.json
          
          cat test.json
          json=$(jq -r tostring $json)
          
          echo "$(jq '. += "'$json'"' test.json)" > test.json
          
          cat test.json
          
          echo '${{ steps.load_variables.outputs.json }}' > output.json
          
          cat output.json
          
          jq -s '.[0] * .[1]' test.json output.json > test.json
          
          json=$(cat test.json)
          
          echo "$json"
          
          echo "json<<EOF" >> $GITHUB_OUTPUT
          echo "$json" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

#      - name: Trigger test workflow
#        uses: actions/github-script@v7
#        with:
#          github-token: ${{ secrets.PAT }}
#          script: |
#            github.rest.actions.createWorkflowDispatch({
#              owner: '3KeyCompany',
#              repo: 'Playground',
#              workflow_id: 'reusable-test-action.yml',
#              ref: 'master',
#              inputs: {
#                'test-folder': '${{ matrix.test-folder }}'
#              }
#            })

  reusable-workflow:
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Print variables
        run: |
          echo '${{ needs.test.outputs.tests }}'
